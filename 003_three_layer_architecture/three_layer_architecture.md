## webサーバーとしてALBを作成する

🌟ALBはWebサーバなのか？？

### ALB用のサブネットの作成

ALB用のサブネットを作成します。

* 🌟サブネット名：alb-subnet
* アベイラビリティーゾーン：ap-northeast-1c
* 🌟IPv4 CIDRブロック：10.0.0.64/26

### セキュリティグループの作成

ALB用のセキュリティグループの作成を行います。

ALBは、インターネットからのHTTPによるアクセスを全て許可したいので、下記のような設定とします。

* セキュリティグループ名：alb-sg001
* VPC：subnetを作成したVPCと同じものを選択する
* インバウンドルール
  * タイプ：HTTP
  * ソース：0.0.0.0/0

### ALBの作成

#### そもそもALBとは

* AWSが提供する負荷分散(LB)のサービス
* HTTP/HTTPSトラフィックに特化したサービス

#### ターゲットグループの作成

ALB作成する前に、ターゲットグループを作成します。

ターゲットグループは、「ALBがトラフィックを振り分ける対象先を定義するリソース」です。EC2インスタンスやLamda関数やURLなどを指定できます。

リスナールール

では作成していきます。

* 基本設定
  * ターゲットタイプ：EC2インスタンス
  * ターゲットグループ名：app-target-group
  * プロトコル：HTTP / ポート：3030
    * 後で3030ポートを開けたnginxを起動する予定のため、3030を指定する
  * VPC：対象となるEC2インスタンスが属するネットワークを選択する
* ターゲットの登録
  * 対象とするEC2インスタンスを選択
    * 後ほど、このインスタンス内にnginxを立ち上げます

ALBはインターネットからのアクセスを受け付ける役割を担うので、80番ポートを開放するように設定します。

* EC2 > ロードバランサー > ロードバランサーの作成
* ロードバランサータイプ：Application Load Balancer
* 基本設定
  * ロードバランサー名：sample-alb
  * 🌟スキーム：インターネット向け
  * 🌟IPアドレスタイプ：IPv4
* ネットワークマッピング
  * VPC：subnetを作成したVPCと同じものを選択する
  * subnet：alb-subnet
* セキュリティグループ
  * 上で作成したalb-sg001を選択する
* 🌟リスナー
  * プロトコル：HTTP
    * HTTP/HTTPSのみ選択可能
  * ポート：80
  * デフォルトアクション：app-target-group(アプリケーションーサーバ(EC2)をターゲットにしたターゲットグループ)

今回は、httpアクセスをapp-target-groupにルーティングするように設定しました。

image

リスナールールを追加することで、より詳細な条件に基づいてトラフィックをルーティングすることもできます。

例えば、パスが`/api`の場合は別のAPI用のサーバにルーティングしたいケースがあるとします。

その場合は、パスパターンが`/api`の時、別のターゲットグループ(API用のサーバをターゲットとして設定したもの)に転送するリスナールールを追加します。

image

#### 注意：ALB作成時に選択するサブネット

ALB作成時には最低2つのサブネットを選択する必要があります。
🌟（ロードバランサーである以上、同じサブネットに所属していたのでは役割が果たせないから？）

また、この時、2つのサブネットは、異なるアベイラビリティゾーンに属する必要があります。

異なるアベイラビリティゾーンに属するサブネットが存在しない場合、サブネットが2つ選択できないため、ALBも作成できません。

#### 注意：インターネットゲートウェイへのルート

ALBはインターネットからのhttpアクセスを受け付けるので、ALB用のサブネットはインターネットからトラフィックを受信できる必要があります。

そのために、ルートテーブルでは所属するVPCのインターネットゲートウェイ(IGW)へのルートが必要です。忘れないように設定しておきます。

* alb-subnetのルートテーブルを選択
* ルートを編集 > ルートを追加
* 送信先：0.0.0.0/0 / ターゲット：対象VPCのインターネットゲートウェイを選択
* 変更を保存

## アプリケーションサーバーの準備

EC2インスタンス上にnginxコンテナを立ち上げます。
🌟nginxはWebサーバだそうだが、今回はテスト的にアプリサーバとしての役割をもつ感じ？

### アプリケーションサーバ用のサブネットの作成

下記の通り、アプリケーションサーバ用のサブネットを作成します。

* サブネット名：app-subnet
* アベイラビリティーゾーン：ap-northeast-1a
* IPv4 CIDRブロック：10.0.0.0/26

### nginxコンテナを準備する

※ 前提として、EC2インスタンスは既に作成済みです。

EC2内でnginxコンテナを起動していきます。

まず、該当のEC2にSSH接続します。

`nginx`ディレクトリを作成し、そこに以下の`docker-compose.yml`を作成します。

```yml
version: '3'

services:
  nginx:
    image: nginx:latest
    🌟ports:
      - "3030:80"
```

ymlファイルを作成したら、`nginx`ディレクトリに移動し、コンテナを起動します。

```bash
[ec2-user@ip-****** ]$ cd nginx
[ec2-user@ip-****** nginx]$ sudo docker-compose up -d
[+] Running 2/2
 ⠿ Network nginx_default    Created                                        0.1s
 ⠿ Container nginx-nginx-1  Started                                        0.9s
[ec2-user@ip-****** nginx]$ sudo docker-compose ps -a
NAME                COMMAND                  SERVICE             STATUS              PORTS
nginx-nginx-1       "/docker-entrypoint.…"   nginx               running             0.0.0.0:3030->80/tcp, :::3030->80/tcp
```

### セキュリティグループの作成

アプリケーションサーバ用のセキュリティグループの作成を行います。

アプリケーションサーバにはALBからのアクセスのみを受け付けるようにしたいので、ソースにALBのセキュリティグループ(alb-sg001)を指定します。

* セキュリティグループ名：sg001
* VPC：subnetを作成したVPCと同じものを選択する
* インバウンドルール
  * タイプ：カスタムTCP
  * ポート範囲：3030
  * ソース：ALBのセキュリティグループを設定（alb-sg001）
    * IPアドレスでも指定できますが、セキュリティグループを指定するのが一般的です

## NATゲートウェイ

### NATゲートウェイとは

**プライベートサブネット内のインスタンスがインターネットと通信するためのサービス**です。

プライベートサブネット内のインスタンスからの通信をインターネットに転送し、返ってきたトラフィックを元のインスタンスにルーティングします。

当たり前ですが、インターネットからプライベートサブネット内のインスタンスへ直接アクセスすることは許可されていません。しかし、ソフトウェアのアップデートなどプライベートサブネット内のインスタンスがインターネットと通信したいケースがあります。そのような場合に、NATゲートウェイを使用します。

🌟なんかメリットが薄いように思ってしまうが。。。他にメリットは？

より具体的には、プライベートIPアドレスをNATゲートウェイのパブリックIPアドレスに変換することで、プライベートサブネットのインスタンスがインターネットと通信できるようになります。

料金が高いので、使用後すぐに削除します😂

### NATゲートウェイの作成

NATゲートウェイを作成していきます。

NATを配置するサブネットは、ALBのあるパブリックサブネットです。
🌟これは慣習的なもの？それとも理由が？

* VPC < NATゲートウェイを作成を開く
* 名前：nat-gateway（任意）
* サブネット：alb-subnet
* 接続タイプ：パブリック
* Elastic IPの割り当てを押す

### ルートテーブルの紐付けを変更

アプリケーションサーバがNATゲートウェイを介してインターネットにアクセスできるようにするため、app-subnet(EC2インスタンスが属するプライベートサブネット)のルートテーブルを変更します。

* "app-subnet"のルートテーブル"app-rtb"を選択
* ルートを編集
  * 送信先：0.0.0.0/0
  * ターゲット：nat-gateway（上で作成したNAT）を選択

### ALBからEC2への疎通確認

これまでの設定によって、ALBにアクセスするとnginxコンテナを起動中のEC2インスタンスにルーティングされます。

結果として、下記のようなnginxのデフォルトのページが表示されるはずです。

image

🌟🌟より詳細の流れは以下の通りです。

1. インターネットからigwを通じて、ルートテーブルにアクセスがある？
   1. この時、ルートテーブルはigwのルートがある状態。ないとインターネットからの通信をルーティングできない
2. トラフィックがALBに対してルーティングされる
   1. これはルートテーブルがやるの？？
   2. ALB用のセキュリティグループは、HTTPアクセス(80番ポート)が開放された状態のため、アクセス可能
3. ALBがアプリケーションサーバ(EC2)に対して、トラフィックをルーティングします
   1. ALBの設定で、HTTPアクセスはアプリケーションサーバに(3030ポートで)ルーティングされます
   2. EC2側ではnginxコンテナが3030ポートがポートマッピングされている？ので、nginxコンテナに到達
4. nginxコンテナに到達したので、nginxのデフォルトページが表示される

## RDSを作成・起動する

### DB用のサブネットの作成

RDSを作成するにあたっては、サブネットグループというものを選択する必要があります。

このサブネットグループは、異なるアベイラビリティゾーンに属する複数のサブネットを持つ必要があります。

そのため、サブネットを2つ作成し、それぞれ異なるアベイラビリティゾーンを選択します。

* DB用のサブネットを作成
  * サブネット名：db-subnet
  * アベイラビリティーゾーン：ap-northeast-1a
  * IPv4 CIDRブロック：10.0.0.128/26
* 2つ目のDB用のサブネットを作成
  * サブネット名：db-subnet2
  * アベイラビリティーゾーン：ap-northeast-1c
  * IPv4 CIDRブロック：10.0.0.192/26

### サブネットグループの作成

上で作成した2つのサブネットを持つサブネットグループを作成します。

* サブネットグループの詳細
  * 名前：db-subnet-group
  * VPC：subnetを作成したVPCと同じものを選択する
* サブネットを追加
  * アベイラビリティゾーン：ap-northeast-1a,ap-northeast-1c
  * サブネット：db-subnet,db-subnet2

### セキュリティグループの作成

DB用のセキュリティグループを作成します。

このセキュリティグループをこの後作成するDBに関連付けることによって、アプリケーションサーバ(EC2)のみがDBにアクセスできるようになります。

* セキュリティグループ名：db-sg001
* VPC：subnetを作成したVPCと同じものを選択する
* インバウンドルール
  * タイプ：MySQL/Aurora
  * ソース：sg001
    * アプリケーションサーバに関連付けしたセキュリティグループを指定します

### RDSの作成

* サービスメニューからRDSを選択
* データベースの作成ボタンを押す
  * データベース作成方法を選択：標準作成
  * エンジンのオプション
    * エンジンのタイプ：MySQL
    * エディション：MySQL Community（デフォルト）
    * エンジンのバージョン：MySQL 8.0.33（デフォルト）
  * テンプレート：無料利用枠
  * 可用性と耐久性：無料利用枠の場合は選択できない
  * 設定
    * DBインスタンス識別子：任意の名前（AWSリージョン内で一意の必要あり）
    * マスターユーザー名：admin
    * マスターパスワード：任意
  * インスタンスの設定
    * db.t2.micro（無料枠内）
  * ストレージ
    * テスト用なので、共に最小値を選択
      * 汎用SSD(gp2)
      * ストレージ割り当て：20
    * ストレージの自動スケーリング：無効
* 接続
  * コンピューティングリソース：EC2コンピューティングリソースに接続しない
    * ※ EC2に接続を選択した場合、自動的にセキュリティグループの設定が変更される。今回は既に手動設定済だったため接続しないを選択
  * VPC：subnetを作成したVPCと同じものを選択する
  * DB サブネットグループ：事前に作成済みの"db-subnet-group"を選択
  * パブリックアクセス：なし
  * 既存のVPCセキュリティグループ：事前に作成済みの"db-sg001"を選択
* 追加設定
  * データベースの選択肢
    * 最初のデータベース名：sample
    * ※ ここを設定すると、RDSインスタンス起動時に自動的にデータベースを作成してくれる

### アプリケーションサーバからRDSインスタンスへの疎通確認

ここまでの設定によって、アプリケーションサーバ(EC2)がRDSインスタンスにアクセスできるようになりました。

アプリケーションサーバ内のnginxコンテナからRDSインスタンスに接続できることを確認します。

nginxコンテナに入り、MySQLクライアントをインストールします。

```bash
[ec2-user@ip-10-0-0-7 nginx]$ sudo docker exec -it コンテナ名 /bin/sh 
$ sudo apt update
All packages are up to date.
$ apt install default-mysql-client
$ mysql -V
mysql  Ver 15.1 Distrib 10.11.3-MariaDB, for debian-linux-gnu (x86_64) using  EditLine wrapper
```

MySQLクライアントがインストールできたので、データベースに接続してみます。

RDSのエンドポイントは、RDSインスタンスの詳細ページに記載されています。

パスワードはRDSインスタンス作成時に設定したものを使ってください。

```bash
$ mysql -h "RDSのエンドポイント" -u admin -p
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 294
Server version: 8.0.33 Source distribution

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> show databases
    -> ;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| sample              |
+--------------------+
5 rows in set (0.012 sec)
```

nginxコンテナからデータベースへの接続が確認できました。

RDSインスタンス作成時に設定した"sample"というデータベースが作成されているのも確認できます。
